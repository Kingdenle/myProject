var data = {
"SequenceID ": "2126931998965363",
"PageType" : "0",
"Records": [
        {
            "Order": "1",
            "Name": "Noah Gundersen  live at Baeble HQ - 10.20.2017",
            "MovieUrl": "https://cdn-baeblemusic-com.akamaized.net/Secure/Noah_Gundersen/noah_gundersen.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/noah_gundersen/noah_gundersen-292.jpg",
            "Info": "Fall in love with English."
        },
        {
            "Order": "2",
            "Name": "Nick Mulvey live at Baeble HQ - 8.16.2017",
            "MovieUrl": "https://cdn-baeblemusic-com.akamaized.net/Secure/Nick_Mulvey/nick_mulvey.mp4",
            "Type": "music",
            "PosterUrl": " https://cdn.baeblemusic.com/bandcontent/nick_mulvey/nick_mulvey-292.jpg",
            "Info": "The boys in the band."
        },
        {
            "Order": "3",
            "Name": "Circa Survive  live at Baeble HQ - 9.25.2017",
            "MovieUrl": " https://cdn-baeblemusic-com.akamaized.net/Secure/Circa_Survive/circa_survive.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/circa_survive/circa_survive-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "4",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/sofi_tukker/sofi_tukker-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "5",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/yoke_lore/yoke_lore-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "6",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": " https://cdn.baeblemusic.com/bandcontent/jr_jr/jrjr_2015update-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "7",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": " https://cdn.baeblemusic.com/bandcontent/romes/romes_bio-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "8",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/the_aces/theaces_promo-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "9",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/tom_walker/tom_walker-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "10",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": " https://cdn.baeblemusic.com/bandcontent/emily_warren/emilywarrenblog-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "11",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/computer_games/computer_games-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "12",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/walker_lukens/walkerlukens_promo-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "13",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/jade_bird/jadebirdblog-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "14",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/alvarez_kings/alvarez_kings_bio-292.jpg",
            "Info": "Blending elements of EDM."
        },
        {
            "Order": "15",
            "Name": "Sofi Tukker live at Baeble HQ - 8.3.2017",
            "MovieUrl": "https://cdn.net/Secure/Sofi_Tukker/sofi_tukker.mp4",
            "Type": "music",
            "PosterUrl": "https://cdn.baeblemusic.com/bandcontent/skylar_stecker/sklyar_stecker_bio-292.jpg",
            "Info": "Blending elements of EDM."
        }
    ]
};

if (chrome == undefined || chrome.getVariableValue == undefined){
  console.log("Chrome webui bunding error");
  chrome = {
    "getVariableValue": function() {
      return "{" + data + "}";
    },
    "send": function(e){
       console.log("chrome:send"+e);
    }
  }
}

  var hiddenElement = function() {
    var onHidden = data.PageType;
    console.log("test<<<<<<<<<<<<<<<<<<<<<<<<<<" + onHidden);
    if(onHidden == 1) {
      headerComponent.items = [document.querySelector("#quitBtn")];
      document.querySelector("#cancel").style.display = "none";
      headerComponent.items[0].style.transform = "translate(8.5vw , 1vh)";
    }else if(onHidden == 0) {
      headerComponent.items = [document.querySelector("#quitBtn"),document.querySelector("#cancel")];
      document.querySelector("#cancel").style.display = "block";
    }
  };

  var headerComponent = {
    template:document.querySelector("#header"),

    selected:0,

    oldSelected:0,

    items:[document.querySelector("#quitBtn"),document.querySelector("#cancel")],

    initialize:function() {
      this.getFocus(this.items[this.selected]);
    },

    getFocus: function(item) {
      item.classList.add('activeBtn');
      item.classList.remove('normalBtn');
      item.focus();
    },

    loseFocus: function(item) {
      item.classList.add('normalBtn');
      item.classList.remove('activeBtn');
    },

    exit: function() {
        switch(data.PageType) {
          case 0: //quitbrowser
            chrome.send("dialogClose" , ["QuitBrowser"]);
            break;
          case 1:
            chrome.send("dialogClose" , ["Back"]);
            break;
        }
    },

    cancel:function() {
      chrome.send("dialogClose" , ['Cancel']);
    },

    onKeyDown: function(event) {
      switch(event.keyCode){
        case 37:
          if(this.selected > 0) {
            this.selected--;
            this.loseFocus(this.items[this.oldSelected]);
            this.getFocus(this.items[this.selected]);
            this.oldSelected = this.selected;
          }
        break;
        case 39:
        if(this.selected < this.items.length - 1) {
          this.selected++;
          this.loseFocus(this.items[this.oldSelected]);
          this.getFocus(this.items[this.selected]);
          this.oldSelected = this.selected;
        }
        break;
        case 40:
          recommendedComponent.getFocus(recommendedComponent.oldDom);
          this.template.classList.add('normalHeader');
          this.loseFocus(this.items[this.selected]);
        break;
        case 13:
          if(this.selected == 0) {
            this.exit();
          }else if(this.selected == 1) {
            this.cancel();
          }
        break;
      }
    }
  };

  var recommendedComponent = {
    noScrollCountAtStart: 3,

    noScrollCountAtEnd: 3,

    noScrollPositionsAtStart : [5.5,23.5,41.5,59.5,77.5,95.5,113.5,131.5,149.5],

    noScrollPositionsAtStart0 : [1.5,43.1,59.7,76.4,93.1,110.7,127.3,144.5,161.5],

    noScrollPositionsAtStart1 : [1.5,18.1,59.7,76.4,93.1,110.7,127.3,144.5,161.5],

    noScrollPositionsAtStart2 : [1.5,18.1,34.7,76.4,93.1,110.7,127.3,144.5,161.5],

    noScrollPositionsAtStart3 :[1.5,18.1,34.7,51.4,93.1,110.7,127.3,144.5,161.5],

    scrollPositions0 : [-17,1.5,18.1,34.7,76.4,93.1,110.7,127.3,144.5],

    scrollPositions : [-12.5,5.5,23.5,41.5,59.5,77.5,95.5,113.5],

    noScrollPositionsAtEnd : [-73,-61,-51,-9.5,8.5,26.5,44.5,62.5,80.5],

    noScrollPositionsAtEnd0 : [-52,-38,-26,-17,1.5,18.1,34.7,76.4,93.1],

    noScrollPositionsAtEnd1 : [-52,-38,-26,-17,1.5,18.1,34.7,51.3,93.1],

    noScrollPositionsAtEnd2 : [-64,-50,-38,-29,-10.5,6.1,22.7,39.3,55.9],

    oldSelected: 0,

    oldDom:null,

    selected: 0,

    container: document.querySelector("#recommendedContainer"),

    title: document.querySelector("#title"),

    iconChangeStatus: true,

    data:{
      list:[],
      intrduction:[],
      name:[],
      movieUrl:[]
    },

    physicalItems: [recommendMovie1,recommendMovie2,recommendMovie3,
    recommendMovie4,recommendMovie5,recommendMovie6,recommendMovie7,
    recommendMovie8,recommendMovie9],

    recommendMovie: Array.prototype.slice.call(document.querySelectorAll(".recommendIcon")),

    iconContainer:Array.prototype.slice.call(document.querySelectorAll(".iconContainer")),

    information:Array.prototype.slice.call(document.querySelectorAll(".information")),

    getFocus: function(focusDom) {
      var domItems = this.physicalItems.map(function(item) {
        return item;
      });
      var newfocusDom;
      newfocusDom = focusDom ? focusDom : domItems[0];
      if(newfocusDom) {
        newfocusDom.focus();
      }
      this.activeState();
      this.refreshPhysicalItems(this.selected , this.oldSelected , true);
    },

    loseFocus: function() {
      this.normalState();
      headerComponent.getFocus(headerComponent.items[headerComponent.selected]);
      headerComponent.template.classList.remove('normalHeader');
      this.refreshPhysicalItems(this.selected , this.oldSelected , true);
    },

    activeState: function() {
      this.recommendMovie[this.selected % this.physicalItems.length].classList.add('activeRecommendIcon');
      this.information[this.selected % this.physicalItems.length].classList.add("active");
      this.container.classList.add('activeRecommendedContainer');
      this.title.classList.add('activeTitle');
    },

    normalState: function() {
      this.recommendMovie[this.oldSelected % this.physicalItems.length].classList.remove('activeRecommendIcon');
      this.information[this.oldSelected % this.physicalItems.length].classList.remove("active");
      this.container.classList.remove('activeRecommendedContainer');
      this.title.classList.remove('activeTitle');
    },

    refreshPhysicalItems:function(newSelectedId, oldSelectedId, animation) {
      if (!(this.data && (this.data.list instanceof Array)
          && this.data.list.length > 0))
          return;

        var newId = newSelectedId ? newSelectedId : 0;
        var oldId = oldSelectedId ? oldSelectedId : 0;
        var xpos;
        var time = animation ? 0.3 : 0;
        var newDisplayIndex;
        var oldDisplayIndex;
        var phyCount = this.physicalItems.length;
        var data = this.data;
        var datalist = this.data.list;
        var virCount = datalist.length;
        var dataIndex;
        var domItems = this.physicalItems.map(function(item) {
          return item;
        });
        for (var index = 0; index < phyCount; index++) {
          if (newId >= 0 && newId < this.noScrollCountAtStart) {
            if(document.activeElement == headerComponent.items[0]||
              document.activeElement == headerComponent.items[1]) {
                newDisplayIndex = index;
                xpos = this.noScrollPositionsAtStart[newDisplayIndex];
                dataIndex = index;
            }else {
              if(newId == 0) {
                newDisplayIndex = index;
                xpos = this.noScrollPositionsAtStart0[newDisplayIndex];
                dataIndex = index;
              }else if (newId == 1) {
                newDisplayIndex = index;
                xpos = this.noScrollPositionsAtStart1[newDisplayIndex];
                dataIndex = index;
              }else if (newId == 2) {
                newDisplayIndex = index;
                xpos = this.noScrollPositionsAtStart2[newDisplayIndex];
                dataIndex = index;
              }else if (newId == 3) {
                newDisplayIndex = index;
                xpos = this.noScrollPositionsAtStart3[newDisplayIndex];
                dataIndex = index;
              }
            }
          }else if (newId >= virCount - this.noScrollCountAtEnd && newId < virCount) {
            if(newId == 12 && newDisplayIndex == 8) {
              time = 0;
            }
            if(document.activeElement == headerComponent.items[0]||
              document.activeElement == headerComponent.items[1]) {
                newDisplayIndex = (phyCount + index - virCount % phyCount) % phyCount;
                xpos = this.noScrollPositionsAtEnd[newDisplayIndex];
                dataIndex = virCount + newDisplayIndex - phyCount;
            }else {
              if(newId == virCount - this.noScrollCountAtEnd) {
                newDisplayIndex = (phyCount + index - virCount % phyCount) % phyCount;
                xpos = this.noScrollPositionsAtEnd0[newDisplayIndex];
                dataIndex = virCount + newDisplayIndex - phyCount;
              }else if(newId == virCount - 2) {
                newDisplayIndex = (phyCount + index - virCount % phyCount) % phyCount;
                xpos = this.noScrollPositionsAtEnd1[newDisplayIndex];
                dataIndex = virCount + newDisplayIndex - phyCount;
              }else if(newId == virCount - 1) {
                newDisplayIndex = (phyCount + index - virCount % phyCount) % phyCount;
                xpos = this.noScrollPositionsAtEnd2[newDisplayIndex];
                dataIndex = virCount + newDisplayIndex - phyCount;
              }
            }
          } else {
            if(document.activeElement == headerComponent.items[0]||
              document.activeElement == headerComponent.items[1]) {
              newDisplayIndex = (phyCount + index - (newId - this.noScrollCountAtStart) % phyCount) % phyCount;
              xpos = this.scrollPositions[newDisplayIndex];
              dataIndex = newId + newDisplayIndex - this.noScrollCountAtStart;
            }else {
              newDisplayIndex = (phyCount + index - (newId - this.noScrollCountAtStart) % phyCount) % phyCount;
              xpos = this.scrollPositions0[newDisplayIndex];
              dataIndex = newId + newDisplayIndex - this.noScrollCountAtStart;
              oldDisplayIndex = (phyCount + index - (oldId - this.noScrollCountAtStart) % phyCount) % phyCount;
              if((newDisplayIndex == phyCount - 1 && oldDisplayIndex == 0)
                || (newDisplayIndex == 0 && oldDisplayIndex == phyCount - 1)) {
                time = 0;
              } else if (animation) {
                time = 0.3;
              }
            }
          }
          if (dataIndex < virCount && dataIndex >= 0){
            this.setCardImage(domItems[index], datalist[dataIndex]);
            this.setCardName(domItems[index], data.name[dataIndex]);
            this.setCardIntrduction(domItems[index], data.intrduction[dataIndex]);
          }else {
            xpos = 101.4;
            time = 0;
          }
          domItems[index].style.transform = 'translate(' + xpos + 'vw' + ',0)';
          domItems[index].style.transition = 'all ' + time + 's';
        }
    },

    refreshIcon: function () {
      this.recommendMovie[this.oldSelected % this.physicalItems.length].classList.remove('activeRecommendIcon');
      this.information[this.oldSelected % this.physicalItems.length].classList.remove("active");
      this.recommendMovie[this.selected % this.physicalItems.length].focus();
      this.recommendMovie[this.selected % this.physicalItems.length].classList.add('activeRecommendIcon');
      this.information[this.selected % this.physicalItems.length].classList.add("active");
      this.refreshPhysicalItems(this.selected , this.oldSelected , true);
    },

    createVideo : function(selected) {
      var videoUrl = this.data.movieUrl[selected];
      chrome.send("dialogClose" , ["play" + videoUrl ]);
    },

    onKeyDown: function (event) {
      if(this.iconChangeStatus) {
        switch(event.keyCode){
          case 37:
            if(this.selected > 0){
              this.selected--;
            }
            this.refreshIcon();
          break;
          case 38:
            this.oldDom = document.activeElement;
            this.loseFocus();
          break;
          case 39:
            if(this.selected < this.data.list.length - 1) {
              this.selected ++;
            }
          this.refreshIcon();
          break;
          case 13:
            this.createVideo(this.selected);
          break;
        }
        this.oldSelected = this.selected;
      }
      this.iconChangeStatus = false;
    },

    onKeyUp: function() {
      this.iconChangeStatus = true;
    },

    setCardImage: function(card, data) {
      if (!card || !data)
        return;
      card.style.backgroundColor = "white";
      card.style.backgroundImage = "url("+data+")";
      card.style.backgroundRepeat = "no-repeat";
    },

    setCardName: function(card , data) {
      if (!card || !data)
        return;
      card.querySelector(".name").innerHTML = data;
    },

    setCardIntrduction: function(card , data) {
      if (!card || !data)
        return;
      card.querySelector(".intrduction").innerHTML = data;
    }
  };

  function json_initialize() {
    var newData = {
      Records:null
    };
    //var newData = JSON.parse(chrome.getVariableValue("dialogArguments"));
    if(newData.Records != undefined && newData.Records.length > 1) {
      data = newData;
    }else {
      data.PageType = newData.PageType;
    }
    console.log(data);
    //document.getElementsByTagName('p')[0].textContent = chrome.dialogArguments;
  }

  document.addEventListener("DOMContentLoaded" , function() {
    json_initialize();
    data.Records.forEach(function(item) {
      recommendedComponent.data.list.push(item.PosterUrl);
      recommendedComponent.data.intrduction.push(item.Info);
      recommendedComponent.data.name.push(item.Name);
      recommendedComponent.data.movieUrl.push(item.MovieUrl);
    })
    headerComponent.initialize();
    recommendedComponent.refreshPhysicalItems(recommendedComponent.selected , recommendedComponent.selected , true);
    hiddenElement();
  });

  document.querySelector("#recommendedContainer").addEventListener("keydown" ,function(event) {
    recommendedComponent.onKeyDown(event);
  });

  document.querySelector("#recommendedContainer").addEventListener("keyup" ,function(event) {
    recommendedComponent.onKeyUp(event);
  });

  document.querySelector("#header").addEventListener("keydown" , function(event) {
    headerComponent.onKeyDown(event);
    var oldItem = document.activeElement;
    window.setTimeout(function() {
      oldItem.focus();
    },100);
  });
